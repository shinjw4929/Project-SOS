# 엔티티 전투

# 전체 흐름

```
[Client] 우클릭 적 → AttackRequestRpc
    ↓
[Server] HandleAttackRequestSystem → Intent.Attack, AggroTarget 설정
    ↓
[SpatialPartitioningGroup]
SpatialMapBuildSystem → TargetingMap 빌드 (셀 크기: 10.0f)
    ↓
[SimulationSystemGroup]
UnifiedTargetingSystem → 적→아군, 유닛→적 자동 타겟팅 (SpatialMaps.TargetingMap 사용)
    ↓
[FixedStepSimulationSystemGroup]
┌──────────────┼──────────────┐
↓              ↓              ↓
MeleeAttack    RangedAttack   CombatDamage
(근접 공격)    (원거리 공격)   (투사체 충돌)
└──────────────┼──────────────┘
               ↓
        DamageEvent 버퍼
               ↓
        DamageApplySystem → Health 적용
               ↓
[SimulationSystemGroup]
ServerDeathSystem → Health ≤ 0 삭제
```

## 컴포넌트 (Shared/Components/)

| 파일 | 역할 |
| --- | --- |
| CombatStats.cs | 공격력(AttackPower), 공격속도(AttackSpeed), 사거리(AttackRange) |
| Health.cs | 현재 체력(CurrentValue), 최대 체력(MaxValue) |
| Defense.cs  | 방어력 (0.0~1.0, 비율 감소) |
| AttackCooldown.cs | 다음 공격까지 남은 시간 (초) |
| AggroTarget.cs | 공격/추적 대상 엔티티 + 마지막 알려진 위치 |
| ProjectileMove.cs | 투사체 방향, 속도, 남은 거리 |

## 버퍼 (Shared/Buffers/)

| 파일 | 역할 |
| --- | --- |
| DamageEvent.cs | 지연 데미지 기록. 여러 시스템이 Health 직접 수정 시 Job 충돌 방지용. DamageApplySystem에서 일괄 적용 |

## 태그 (Shared/Components/Tags/)

| 파일 | 역할 | 적용 대상 |
| --- | --- | --- |
| RangedUnitTag.cs | 원거리 유닛 표시 (MeleeAttackSystem 제외) | Trooper, Sniper |
| RangedEnemyTag.cs | 원거리 적 표시 (MeleeAttackSystem 제외) | EnemyFlying |
| VisualOnlyTag.cs | 시각 전용 투사체 (데미지 없음, CombatDamageSystem 제외) | 원거리 공격 시 생성 투사체 |

## 서버 시스템 (Server/Systems/)

### 타겟팅 시스템

파일: UnifiedTargetingSystem.cs
그룹: SimulationSystemGroup (UpdateAfter: SpatialPartitioningGroup, HandleAttackRequestSystem)
역할: 통합 타겟팅 시스템. SpatialMaps.TargetingMap을 사용하여 공간 분할 기반 탐색.
- EnemyTargetJob: 적→아군 타겟팅 (유닛/건물 탐색, 타겟 없으면 랜덤 배회)
- UnitAutoTargetJob: 유닛→적 자동 감지 (명령 없는 유닛의 자동 전투)
- 최적화: 타겟 고착화(Hysteresis), 시간 분할(Time Slicing)

---

### 전투 시스템 (Server/Systems/Combat/)

파일: HandleAttackRequestSystem.cs
그룹: SimulationSystemGroup
역할: AttackRequestRpc 수신 → 소유권 검증 → UnitIntentState=Attack, AggroTarget 설정, MovementGoal 갱신 (추격 시작)
---
파일: MeleeAttackSystem.cs
그룹: FixedStepSimulationSystemGroup (UpdateAfter: PhysicsSystemGroup)
역할: 근접 공격 처리. 두 개 Job: EnemyMeleeAttackJob(적), UnitMeleeAttackJob(유닛). 거리 판정 → 사거리 내면 DamageEvent 추가 + 쿨다운 리셋, 사거리 밖이면 추격. RangedUnitTag/RangedEnemyTag 제외
---
파일: RangedAttackSystem.cs
그룹: FixedStepSimulationSystemGroup (UpdateAfter: MeleeAttackSystem)
역할: 원거리 공격 처리. RangedUnitTag/RangedEnemyTag 대상. 필중 시스템: 거리 판정 후 즉시 DamageEvent 추가 + 시각 투사체 생성(VisualOnlyTag 포함). 사거리 내면 이동 정지, 밖이면 추격
---
파일: CombatDamageSystem.cs
그룹: FixedStepSimulationSystemGroup (UpdateAfter: PhysicsSimulationGroup)
역할: Physics Trigger 기반 투사체 충돌 처리. VisualOnlyTag 제외. 충돌 시 DamageEvent 추가 + 투사체 삭제. NativeHashSet으로 프레임당 중복 히트 방지
---
파일: DamageApplySystem.cs
그룹: FixedStepSimulationSystemGroup (UpdateAfter: MeleeAttackSystem)
역할: DamageEvent 버퍼 합산 → Health에 적용 → 버퍼 클리어. 핵심: 모든 데미지 시스템의 결과를 일괄 처리
---
파일: ServerDeathSystem.cs
그룹: SimulationSystemGroup
역할: Health ≤ 0인 엔티티 삭제 (ECB.DestroyEntity)

## 클라이언트 시스템 (Client/Systems/Combat/)

파일: ClientDeathSystem.cs
그룹: SimulationSystemGroup
역할: Health ≤ 0인 엔티티에 DisableRendering 추가. 서버 삭제 전까지 렌더링만 끔 (갑작스러운 사라짐 방지)
---
파일: ProjectileVisualSystem.cs
그룹: SimulationSystemGroup
역할: 시각 투사체(VisualOnlyTag) 이동. RemainingDistance 감소 → 0 이하면 삭제. (RPC 미사용, Ghost 복제로 동기화)

## 공간 분할 시스템 (Server/Systems/Spatial/)

파일: SpatialMapBuildSystem.cs
그룹: SpatialPartitioningGroup (OrderFirst=true)
역할: 공간 분할 맵 빌드
- TargetingMap (셀 크기: 10.0f): 타겟팅용 공간 해시맵
- MovementMap (셀 크기: 3.0f): 이동 충돌 회피용 (대형 유닛 AABB 등록)
- 결과를 SpatialMaps 싱글톤에 저장
---
파일: SpatialMapDisposeSystem.cs
그룹: LateSimulationSystemGroup
역할: 공간 분할 맵 해제. CompleteDependency() 후 맵 Dispose

## Shared 시스템 (Shared/Systems/)

파일: ProjectileMoveSystem.cs
그룹: SimulationSystemGroup
역할: 투사체 이동 (서버/클라이언트 공용). Direction * Speed * dt 이동, RemainingDistance 감소

## 유틸리티 (Shared/Utilities/)

| 파일 | 역할 |
| --- | --- |
| DamageUtility.cs | 데미지 계산: finalDamage = baseDamage * (1 - defense). Defense 0.3이면 30% 감소 |

## RPC (Shared/RPCs/)

| 파일 | 역할 |
| --- | --- |
| AttackRequestRpc.cs | 공격 명령 RPC. UnitGhostId, TargetGhostId, TargetPosition 포함 |

## 핵심 설계 포인트

### 1. DamageEvent 버퍼 패턴

DamageEvent 버퍼에 기록 → DamageApplySystem에서 일괄 적용

### 2. 공격 타입별 처리

| 타입 | 시스템 | 필터 | 데미지 방식 |
| --- | --- | --- | --- |
| 근접 | MeleeAttackSystem | WithNone<RangedUnitTag/RangedEnemyTag> | 거리 판정 → DamageEvent |
| 원거리 | RangedAttackSystem | WithAll<RangedUnitTag/RangedEnemyTag> | 거리 판정 → 즉시 DamageEvent (필중) + 시각 투사체 |
| 투사체 | CombatDamageSystem | Physics Trigger | 충돌 시 DamageEvent |

### 3. 시각 투사체 (원거리 공격)

서버: RangedAttackSystem
→ 데미지 즉시 적용 (필중)
→ 투사체 엔티티 생성 + VisualOnlyTag + ProjectileMove
→ Ghost로 클라이언트 복제

클라이언트: ProjectileVisualSystem
→ 복제된 투사체 이동 표시
→ RemainingDistance ≤ 0 삭제

### 4. 시스템 실행 순서

```
[SpatialPartitioningGroup] ─────────────────────────────
SpatialMapBuildSystem (OrderFirst)
    → TargetingMap 빌드 (셀 크기: 10.0f)
    → MovementMap 빌드 (셀 크기: 3.0f)
    → SpatialMaps 싱글톤에 저장

[SimulationSystemGroup] ─────────────────────────────────
HandleAttackRequestSystem
    ↓ UpdateAfter
UnifiedTargetingSystem (SpatialMaps.TargetingMap 사용)
    ├─ EnemyTargetJob (적→아군 타겟팅)
    └─ UnitAutoTargetJob (유닛→적 자동 감지)

[FixedStepSimulationSystemGroup] ────────────────────────
PhysicsSystemGroup
    └─ PhysicsSimulationGroup
        ↓ UpdateAfter
    CombatDamageSystem (투사체 충돌, VisualOnlyTag 제외)
        ↓ UpdateAfter: PhysicsSystemGroup
MeleeAttackSystem (근접, RangedUnitTag/RangedEnemyTag 제외)
    ↓ UpdateAfter
RangedAttackSystem (원거리, RangedUnitTag/RangedEnemyTag 대상)
DamageApplySystem (데미지 적용, UpdateAfter: MeleeAttackSystem)

[SimulationSystemGroup] ─────────────────────────────────
ServerDeathSystem → Health ≤ 0 삭제

[LateSimulationSystemGroup] ─────────────────────────────
SpatialMapDisposeSystem → 공간 분할 맵 해제
```

### 5. 공간 분할 최적화 기법

| 기법 | 설명 |
| --- | --- |
| 타겟 고착화 (Hysteresis) | LoseTargetDistance = DetectionRange × 1.3배 |
| 시간 분할 (Time Slicing) | entity.Index % 4 == frameCount % 4인 유닛만 탐색 |
| 대형 유닛 AABB | radius > CellSize × 0.5f인 경우 여러 셀에 등록 |
| 해시 충돌 방지 | capacity = entityCount × 1.5f |