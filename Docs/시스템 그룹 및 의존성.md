# 시스템 그룹 및 의존성

## 1. InitializationSystemGroup

| 시스템 | 위치 | 의존성 |
|--------|------|--------|
| ClientBootstrapSystem | Client | OrderFirst=true |
| CatalogIndexMapInitSystem | Client | UpdateAfter: ClientBootstrapSystem |
| ObstacleGridInitSystem | Shared | - |
| GamePhaseInitSystem | Server | - |

---

## 2. GhostInputSystemGroup (Client 입력)

```
UserSelectionInputUpdateSystem
    ↓ UpdateAfter
EntitySelectionSystem
    ↓ UpdateAfter
SelectedEntityInfoUpdateSystem
    ↓ UpdateAfter
UnitCommandInputSystem
    ↓ UpdateAfter
StructurePlacementInputSystem

별도 시스템:
- ConstructionMenuInputSystem (독립)
- StructureCommandInputSystem (UpdateAfter: SelectedEntityInfoUpdateSystem)
```

---

## 3. PredictedSimulationSystemGroup

| 시스템 | 위치 | 의존성 |
|--------|------|--------|
| GhostIdLookupSystem | Shared | OrderFirst=true |

---

## 4. FixedStepSimulationSystemGroup (Server 전투)

```
PhysicsSystemGroup
└── PhysicsSimulationGroup
        ↓ UpdateAfter
    CombatDamageSystem (투사체 충돌 → DamageEvent)
            ↓ UpdateAfter: PhysicsSystemGroup
MeleeAttackSystem (근접 공격 → DamageEvent)
    ↓ UpdateAfter
RangedAttackSystem (원거리 필중 → DamageEvent + 시각 투사체)
DamageApplySystem (UpdateAfter: MeleeAttackSystem, DamageEvent → Health)
```

**공격 흐름:**
- `CombatDamageSystem`: Physics Trigger 기반, VisualOnlyTag 제외
- `MeleeAttackSystem`: RangedUnitTag/RangedEnemyTag 제외
- `RangedAttackSystem`: RangedUnitTag/RangedEnemyTag 대상, 필중 데미지
- `DamageApplySystem`: DamageEvent 버퍼 합산 → Health 적용

---

## 5. SimulationSystemGroup

### 5-1. SpatialPartitioningGroup (Server, 별도 그룹)

| 시스템 | 의존성 | 역할 |
|--------|--------|------|
| SpatialMapBuildSystem | OrderFirst=true | TargetingMap(10.0f) + MovementMap(3.0f) 빌드 |

### 5-2. Server 시스템

| 시스템 | 의존성 |
|--------|--------|
| HandleMoveRequestSystem | - |
| HandleAttackRequestSystem | - |
| HandleBuildRequestSystem | - |
| HandleBuildMoveRequestSystem | - |
| HandleGatherRequestSystem | - |
| HandleReturnResourceRequestSystem | - |
| HandleProduceUnitRequestSystem | - |
| **UnifiedTargetingSystem** | UpdateAfter: SpatialPartitioningGroup, HandleAttackRequestSystem |
| NavMeshObstacleSpawnSystem | - |
| PathfindingSystem | UpdateAfter: NavMeshObstacleSpawnSystem |
| PathFollowSystem | UpdateAfter: PathfindingSystem |
| PredictedMovementSystem | UpdateAfter: PathfindingSystem |
| MovementArrivalSystem | UpdateAfter: PredictedMovementSystem |
| BuildArrivalSystem | UpdateAfter: MovementArrivalSystem |
| SelfDestructTimerSystem | UpdateBefore: HandleSelfDestructRequestSystem |
| HandleSelfDestructRequestSystem | - |
| WorkerCarriedResourceSpawnSystem | - |
| WorkerGatheringSystem | UpdateAfter: HandleBuildRequestSystem |
| ProductionProgressSystem | - |
| EnemyDeathCountSystem | UpdateBefore: ServerDeathSystem |
| ServerDeathSystem | - |
| NavMeshObstacleCleanupSystem | UpdateAfter: ServerDeathSystem |
| TechStateRecalculateSystem | UpdateAfter: ServerDeathSystem |
| InitialWallDecaySystem | - |
| HeroDamageOnContactServerSystem | - |
| WaveManagerSystem | - |
| EnemySpawnerSystem | UpdateAfter: WaveManagerSystem |
| FireProjectileServerSystem | OrderLast=true |
| ResourceNodeCleanupSystem | OrderLast=true |

### 5-3. Shared 시스템

| 시스템 | 역할 |
|--------|------|
| ProjectileMoveSystem | 투사체 이동 |

### 5-4. Client 시스템

| 시스템 | 역할 |
|--------|------|
| SelectionRingSpawnSystem | 선택 링 생성 |
| NotificationReceiveSystem | 서버 알림 수신 |
| ClientDeathSystem | 클라이언트 사망 처리 |
| ProjectileVisualSystem | 시각 투사체 이동 |
| GoInGameClientSystem | 게임 진입 |

---

## 6. LateSimulationSystemGroup

| 시스템 | 위치 | 역할 |
|--------|------|------|
| GridOccupancyEventSystem | Shared | 그리드 점유 갱신 |
| SpatialMapDisposeSystem | Server | 공간 분할 맵 해제 (CompleteDependency) |

---

## 7. TransformSystemGroup

| 시스템 | 위치 | 역할 |
|--------|------|------|
| CarriedResourceFollowSystem | Shared | Worker 위치 추적, Scale로 가시성 제어 |
| SelectionVisualizationSystem | Client | 선택 링 시각화 |

---

## 8. PresentationSystemGroup (Client)

| 시스템 | 역할 |
|--------|------|
| StructurePreviewUpdateSystem | 건설 프리뷰 |
| HeroHpTextPresentationSystem | 영웅 HP 텍스트 |
| EnemyHpTextPresentationSystem | 적 HP 텍스트 |
| CameraSystem | 카메라 이동 |

---

## 핵심 의존성 흐름

```
[입력] GhostInputSystemGroup (Client)
    UserSelectionInputUpdateSystem → EntitySelectionSystem
    → SelectedEntityInfoUpdateSystem → UnitCommandInputSystem
    → RPC 전송 (MoveRequestRpc, AttackRequestRpc, BuildRequestRpc 등)

[공간 분할] SpatialPartitioningGroup (Server)
    SpatialMapBuildSystem → TargetingMap + MovementMap → SpatialMaps 싱글톤

[명령 처리] SimulationSystemGroup (Server)
    HandleMoveRequestSystem → MovementGoal 설정
    HandleAttackRequestSystem → AggroTarget 설정
    HandleBuildRequestSystem / HandleBuildMoveRequestSystem → 건설 처리

[타겟팅] SimulationSystemGroup (Server)
    UnifiedTargetingSystem (SpatialMaps.TargetingMap 사용)
    ├── EnemyTargetJob: 적 → 아군 타겟팅
    └── UnitAutoTargetJob: 유닛 → 적 자동 감지

[이동] SimulationSystemGroup (Server)
    PathfindingSystem → PredictedMovementSystem (MovementMap 사용)
    → MovementArrivalSystem → BuildArrivalSystem

[전투] FixedStepSimulationSystemGroup (Server)
    CombatDamageSystem → MeleeAttackSystem → RangedAttackSystem
    → DamageApplySystem

[정리] SimulationSystemGroup (Server)
    ServerDeathSystem → NavMeshObstacleCleanupSystem

[후처리] LateSimulationSystemGroup
    GridOccupancyEventSystem → SpatialMapDisposeSystem

[렌더링] PresentationSystemGroup (Client)
    UI 시스템들 실행
```

---

## 핵심 포인트

### CompleteDependency 호출 위치
- `SpatialMapDisposeSystem`: 공간 분할 맵 해제 전

### OrderFirst/OrderLast 사용
- `ClientBootstrapSystem` (InitializationSystemGroup, OrderFirst)
- `GhostIdLookupSystem` (PredictedSimulationSystemGroup, OrderFirst)
- `SpatialMapBuildSystem` (SpatialPartitioningGroup, OrderFirst)
- `FireProjectileServerSystem` (SimulationSystemGroup, OrderLast)
- `ResourceNodeCleanupSystem` (SimulationSystemGroup, OrderLast)

### DamageEvent 버퍼 패턴
1. `CombatDamageSystem`: 투사체 충돌 → DamageEvent 추가
2. `MeleeAttackSystem`: 근접 공격 → DamageEvent 추가
3. `RangedAttackSystem`: 원거리 공격 → DamageEvent 추가
4. `DamageApplySystem`: DamageEvent 합산 → Health 적용

### 공간 분할 패턴
- `TargetingMap` (셀 10.0f): 타겟팅 시스템용
- `MovementMap` (셀 3.0f): 이동 충돌 회피용
- 시간 분할: 4프레임당 1회 탐색 (UnitAutoTargetJob)
- 타겟 고착화: LoseTargetDistance x 1.3배
