# 시스템 그룹 및 의존성

## 1. InitializationSystemGroup

| 시스템 | WorldFilter | 의존성 | 역할 |
|--------|-------------|--------|------|
| ClientBootstrapSystem | Client | OrderFirst=true | 클라이언트 싱글톤 초기화 (UserState, SelectionState 등) |
| CatalogIndexMapInitSystem | Client | UpdateAfter: ClientBootstrapSystem | 카탈로그 Index Map 생성 |
| ObstacleGridInitSystem | Client \| Server | - | 초기 배치 건물의 GridPosition 계산 및 그리드 점유 등록 |
| GamePhaseInitSystem | Server | - | GamePhaseState + GhostDistanceImportance 싱글톤 생성 |

---

## 2. GhostInputSystemGroup (Client 입력)

```
UserSelectionInputUpdateSystem (마우스 입력 → SelectionPhase 상태)
    ↓ UpdateAfter
EntitySelectionSystem (Phase 기반 엔티티 선택)
    ↓ UpdateAfter
SelectedEntityInfoUpdateSystem (선택 엔티티 정보 상태 업데이트)
    ↓ UpdateAfter
UnitCommandInputSystem (이동, 공격, 채집 RPC 전송)
    ↓ UpdateAfter
StructurePlacementInputSystem (건설 모드 입력 처리)

별도 시스템:
- ConstructionMenuInputSystem (독립 - 건설 메뉴 입력)
- StructureCommandInputSystem (UpdateAfter: SelectedEntityInfoUpdateSystem - 생산, 자폭 명령)
```

---

## 3. PredictedSimulationSystemGroup

| 시스템 | WorldFilter | 의존성 | 역할 |
|--------|-------------|--------|------|
| GhostIdLookupSystem | Shared | OrderFirst=true | GhostId → Entity 매핑 생성 |

---

## 4. SpatialPartitioningGroup (Server, 별도 그룹)

| 시스템 | 의존성 | 역할 |
|--------|--------|------|
| SpatialMapBuildSystem | OrderFirst=true | TargetingMap(10.0f) + MovementMap(3.0f) 빌드 |

---

## 5. FixedStepSimulationSystemGroup (Server 전투)

```
PhysicsSystemGroup
└── PhysicsSimulationGroup
        ↓ UpdateAfter
    CombatDamageSystem (투사체 충돌 → DamageEvent)
            ↓ UpdateAfter: PhysicsSystemGroup
MeleeAttackSystem (근접 공격 → DamageEvent)
    ↓ UpdateAfter
RangedAttackSystem (원거리 필중 → DamageEvent + 시각 투사체)
    ↓ UpdateAfter
AggroReactionSystem (피격 어그로 반응 → DamageEvent.Attacker 읽기)
    ↓ UpdateBefore: DamageApplySystem
DamageApplySystem (DamageEvent → Health + 버퍼 클리어)
```

**공격 흐름:**
- `CombatDamageSystem`: Physics Trigger 기반, VisualOnlyTag 제외
- `MeleeAttackSystem`: RangedUnitTag/RangedEnemyTag 제외
- `RangedAttackSystem`: RangedUnitTag/RangedEnemyTag 대상, 필중 데미지
- `AggroReactionSystem`: DamageEvent.Attacker 읽어 어그로 전환, AggroLock 설정
- `DamageApplySystem`: DamageEvent 버퍼 합산 → Health 적용 + 버퍼 클리어

---

## 6. SimulationSystemGroup

### 6-1. SpatialPartitioningGroup (Server, 별도 그룹)

| 시스템 | 의존성 | 역할 |
|--------|--------|------|
| SpatialMapBuildSystem | OrderFirst=true | TargetingMap(10.0f) + MovementMap(3.0f) 빌드 |

### 6-2. Server 시스템

| 시스템 | 의존성 | 역할 |
|--------|--------|------|
| HandleMoveRequestSystem | - | 이동 RPC 처리 |
| HandleAttackRequestSystem | - | 공격 RPC 처리 |
| HandleBuildRequestSystem | - | 건설 RPC 처리 |
| HandleBuildMoveRequestSystem | - | 건설 이동 RPC 처리 |
| HandleGatherRequestSystem | - | 채집 RPC 처리 |
| HandleReturnResourceRequestSystem | - | 자원 반납 RPC 처리 |
| HandleProduceUnitRequestSystem | - | 유닛 생산 RPC 처리 |
| SelfDestructTimerSystem | UpdateBefore: HandleSelfDestructRequestSystem | 자폭 타이머 |
| HandleSelfDestructRequestSystem | - | 자폭 RPC 처리 |
| **UnifiedTargetingSystem** | UpdateAfter: SpatialPartitioningGroup, HandleAttackRequestSystem <br> UpdateBefore: PathfindingSystem | 타겟팅 (공간 분할 기반) |
| NavMeshObstacleSpawnSystem | - | NavMeshObstacle 동적 생성 |
| PathfindingSystem | UpdateAfter: NavMeshObstacleSpawnSystem | NavMesh 경로 계산 (8 IJob 병렬, 최대 512개/프레임) |
| PathFollowSystem | UpdateAfter: PathfindingSystem, UpdateBefore: PredictedMovementSystem | 웨이포인트 버퍼 관리 |
| PredictedMovementSystem | UpdateAfter: PathfindingSystem | 이동 + 충돌 회피 |
| MovementArrivalSystem | UpdateAfter: PredictedMovementSystem | 이동 도착 판정 |
| BuildArrivalSystem | UpdateAfter: MovementArrivalSystem | 도착 시 건설 실행 |
| WorkerCarriedResourceSpawnSystem | - | 운반 자원 엔티티 생성 |
| WorkerGatheringSystem | UpdateAfter: HandleBuildRequestSystem | 자원 채집 처리 |
| ProductionProgressSystem | - | 유닛 생산 진행 |
| **HeroDeathDetectionSystem** | UpdateBefore: ServerDeathSystem | Hero 사망 감지 + 게임오버 RPC |
| ServerDeathSystem | - | 사망 엔티티 파괴 + 인구수 반환 |
| NavMeshObstacleCleanupSystem | UpdateAfter: ServerDeathSystem | NavMeshObstacle 정리 |
| TechStateRecalculateSystem | UpdateAfter: ServerDeathSystem | ResourceCenter 파괴 시 테크 재계산 |
| InitialWallDecaySystem | - | 초기 벽 자동 파괴 |
| ~~HeroDamageOnContactServerSystem~~ | - | [비활성화] Hero 접촉 데미지 |
| WaveManagerSystem | - | Wave 전환 조건 체크 |
| EnemySpawnerSystem | UpdateAfter: WaveManagerSystem | 적 스폰 |
| GoInGameServerSystem | - | 클라이언트 접속 시 Hero 생성 + GhostConnectionPosition 부착 |
| UpdateConnectionPositionSystem | - | Hero 위치 → Connection GhostConnectionPosition 동기화 |
| ResourceNodeCleanupSystem | OrderLast=true | 빈 자원 노드 정리 |

### 6-3. Shared 시스템

| 시스템 | WorldFilter | 역할 |
|--------|-------------|------|
| ProjectileMoveSystem | Server (PhysicsSystemGroup 내) | 투사체 이동 및 소멸 |

### 6-4. Client 시스템

| 시스템 | 의존성 | 역할 |
|--------|--------|------|
| SelectionRingSpawnSystem | - | 선택 링 엔티티 자동 생성 |
| NotificationReceiveSystem | - | 서버 알림 RPC 수신 |
| GameOverReceiveSystem | - | HeroDeathRpc, GameOverRpc 수신 |
| ClientDeathSystem | - | 사망 엔티티 렌더링 비활성화 |
| ProjectileVisualSystem | - | 시각 효과 투사체 생성 |
| ClientProjectileMoveSystem | UpdateAfter: ProjectileVisualSystem | 시각 투사체 이동 |
| GoInGameClientSystem | - | 게임 진입 |

---

## 7. LateSimulationSystemGroup

| 시스템 | WorldFilter | 역할 |
|--------|-------------|------|
| GridOccupancyEventSystem | Client \| Server | 그리드 점유 갱신 (Reactive) |
| PopulationApplySystem | Server | PopulationEvent 버퍼 소비 → UserSupply.Currentvalue 감소 적용 |

---

## 8. TransformSystemGroup

| 시스템 | WorldFilter | 역할 |
|--------|-------------|------|
| CarriedResourceFollowSystem | Shared | Worker 위치 추적, Scale로 가시성 제어 |
| SelectionVisualizationSystem | Client | 선택 링 위치 업데이트 |

---

## 9. PresentationSystemGroup (Client)

| 시스템 | 역할 |
|--------|------|
| StructurePreviewUpdateSystem | 건설 프리뷰 상태 업데이트 |
| ~~HeroHpTextPresentationSystem~~ | [비활성화] Hero HP 텍스트 UI |
| EnemyHpTextPresentationSystem | 적 HP 텍스트 UI |
| CameraSystem | 카메라 이동 |

---

## 핵심 의존성 흐름

```
[입력] GhostInputSystemGroup (Client)
    UserSelectionInputUpdateSystem → EntitySelectionSystem
    → SelectedEntityInfoUpdateSystem → UnitCommandInputSystem
    → RPC 전송 (MoveRequestRpc, AttackRequestRpc, BuildRequestRpc 등)

[공간 분할] SpatialPartitioningGroup (Server)
    SpatialMapBuildSystem → TargetingMap + MovementMap → SpatialMaps 싱글톤

[명령 처리] SimulationSystemGroup (Server)
    HandleMoveRequestSystem → MovementGoal 설정
    HandleAttackRequestSystem → AggroTarget 설정
    HandleBuildRequestSystem / HandleBuildMoveRequestSystem → 건설 처리

[타겟팅] SimulationSystemGroup (Server)
    UnifiedTargetingSystem (SpatialMaps.TargetingMap 사용)
    ├── EnemyTargetJob: 적 → 아군 타겟팅
    └── UnitAutoTargetJob: 유닛 → 적 자동 감지

[이동] SimulationSystemGroup (Server)
    PathfindingSystem (Collect→Compute×8→Apply) → PathFollowSystem → PredictedMovementSystem (MovementMap 사용)
    → MovementArrivalSystem → BuildArrivalSystem

[전투] FixedStepSimulationSystemGroup (Server)
    CombatDamageSystem → MeleeAttackSystem → RangedAttackSystem
    → AggroReactionSystem → DamageApplySystem

[정리] SimulationSystemGroup (Server)
    HeroDeathDetectionSystem → ServerDeathSystem
    → NavMeshObstacleCleanupSystem + TechStateRecalculateSystem

[후처리] LateSimulationSystemGroup
    GridOccupancyEventSystem

[렌더링] PresentationSystemGroup (Client)
    UI 시스템들 실행
```

---

## 핵심 포인트

### CompleteDependency 호출 위치
- (없음: Persistent 맵 + Job dependency chain으로 CompleteDependency 완전 제거)

### OrderFirst/OrderLast 사용
- `ClientBootstrapSystem` (InitializationSystemGroup, OrderFirst)
- `GhostIdLookupSystem` (PredictedSimulationSystemGroup, OrderFirst)
- `SpatialMapBuildSystem` (SpatialPartitioningGroup, OrderFirst)
- `ResourceNodeCleanupSystem` (SimulationSystemGroup, OrderLast)

### DamageEvent 버퍼 패턴
1. `CombatDamageSystem`: 투사체 충돌 → DamageEvent 추가 (Attacker 포함)
2. `MeleeAttackSystem`: 근접 공격 → DamageEvent 추가 (Attacker 포함)
3. `RangedAttackSystem`: 원거리 공격 → DamageEvent 추가 (Attacker 포함)
4. `AggroReactionSystem`: DamageEvent.Attacker 읽어 어그로 전환 + AggroLock 설정
5. `DamageApplySystem`: DamageEvent 합산 → Health 적용 + 버퍼 클리어 + 적 킬 카운트 (GamePhaseState.TotalKillCount)

### GhostDistanceImportance 패턴
- `GamePhaseInitSystem`에서 `GhostDistanceData` + `GhostImportance` 싱글톤 생성 (TileSize=50)
- `GoInGameServerSystem`에서 Connection에 `GhostConnectionPosition` 부착
- `UpdateConnectionPositionSystem`에서 매 틱 Hero 위치를 GhostConnectionPosition에 반영
- Netcode 내장 `GhostDistancePartitioningSystem`이 자동으로 Ghost에 타일 인덱스 부여
- Hero 근처 Ghost는 높은 빈도로 스냅샷 전송, 먼 Ghost는 빈도 감소

### 공간 분할 패턴
- `TargetingMap` (셀 10.0f): 타겟팅 시스템용
- `MovementMap` (셀 3.0f): 이동 충돌 회피용
- **Persistent 맵 재사용**: Allocator.Persistent로 한 번 할당, 매 프레임 Job 기반 Clear + 재빌드
- **CompleteDependency 제거**: ClearJob이 state.Dependency를 통해 이전 소비 시스템의 read handle 대기
- 시간 분할: 4프레임당 1회 탐색 (UnitAutoTargetJob)
- 타겟 고착화: LoseTargetDistance x 1.3배
