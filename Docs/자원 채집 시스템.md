# 자원 채집 시스템

## 전체 흐름

```
[Client] ResourceNode 우클릭 (Worker 선택 상태)
       ↓
GatherRequestRpc 전송
       ↓
[Server] HandleGatherRequestSystem
├─ 점유 확인 → Phase 결정 (MovingToNode / WaitingForNode)
├─ GatheringTarget 설정
├─ Intent.Gather + Action.Moving 설정
└─ MovementGoal 설정 (노드 표면으로)
       ↓
PathfindingSystem → PredictedMovementSystem
       ↓
[Server] WorkerGatheringSystem (5단계 사이클)
├─ MovingToNode: 노드 도착 → 점유 설정 → Gathering
├─ Gathering: Progress 100% → CarriedAmount 증가 → 점유 해제 → MovingToReturn
├─ MovingToReturn: 반납지 도착 → Unloading
├─ Unloading: Progress 100% → UserCurrency 증가 → CarriedAmount=0 → 자동 복귀 또는 Idle
└─ WaitingForNode: 점유 해제 감지 → Gathering 전환
       ↓
(AutoReturn = true 시 반복)
```

## 핵심 설계 포인트

1. **5단계 GatherPhase 사이클**: MovingToNode → Gathering → MovingToReturn → Unloading → (자동 복귀)
2. **단일 점유 시스템**: 한 ResourceNode에 1개 Worker만 채집 가능 (OccupyingWorker)
3. **Scale 기반 시각화**: CarriedResource 생성/삭제 없이 Scale 0/1 토글로 가시성 제어
4. **Intent + Action + Phase 3단계 상태**: 큰 의도(Gather) → 행동(Moving/Working) → 세부 단계(Phase)

---

## 클라이언트 시스템 (Client/Systems/)

| 파일 | 그룹 | 역할 |
| --- | --- | --- |
| UnitCommandInputSystem.cs | GhostInputSystemGroup | Worker 선택 + ResourceNode 우클릭 → GatherRequestRpc 전송, Worker 선택 + ResourceCenter 우클릭 (자원 보유 시) → ReturnResourceRequestRpc 전송 |

---

## 서버 시스템 (Server/Systems/)

| 파일 | 그룹 | 역할 |
| --- | --- | --- |
| HandleGatherRequestSystem.cs | SimulationSystemGroup | GatherRequestRpc 수신 → 점유 확인, GatheringTarget 설정, Intent.Gather + Phase 결정, MovementGoal 설정 |
| HandleReturnResourceRequestSystem.cs | SimulationSystemGroup | ReturnResourceRequestRpc 수신 → CarriedAmount>0 검증, LastGatheredNode 저장, Phase.MovingToReturn 설정 |
| WorkerGatheringSystem.cs | SimulationSystemGroup (UpdateAfter: HandleBuildRequestSystem) | 채집 사이클 5단계 처리. ProcessMovingToGather → ProcessGathering → ProcessMovingToReturn → ProcessUnloading → ProcessWaitingForNode |
| WorkerCarriedResourceSpawnSystem.cs | SimulationSystemGroup | Worker 생성 감지 → CarriedResource 엔티티 생성, LinkedEntityGroup에 추가 (자동 삭제용) |
| ResourceNodeCleanupSystem.cs | SimulationSystemGroup (OrderLast=true) | 점유 상태 유효성 검사 + 타겟 유효성 검사. Worker 사망/삭제/타겟 변경 시 점유 해제, ResourceNode/ReturnPoint 삭제 시 대체 탐색 또는 Idle 전환 |

---

## 공용 시스템 (Shared/Systems/)

| 파일 | 그룹 | 역할 |
| --- | --- | --- |
| CarriedResourceFollowSystem.cs | TransformSystemGroup | CarriedResource 위치 업데이트 (Worker 머리 위 Y+1.2f), Scale 기반 가시성 토글 (CarriedAmount > 0 → Scale=1, 아니면 Scale=0) |

---

## 컴포넌트 - 상태 (Shared/Components/State/)

| 파일 | 역할 |
| --- | --- |
| WorkerState.cs | Worker 채집 상태. CarriedAmount (운반량), CarriedType (ResourceType), GatheringProgress (진행도 0~1), Phase (GatherPhase 6가지) |
| GatheringTarget.cs | 채집 대상 정보. ResourceNodeEntity (채집 노드), ReturnPointEntity (반납 지점), AutoReturn (자동 복귀 여부), LastGatheredNodeEntity (복귀할 노드) |
| ResourceNodeState.cs | 자원 노드 상태. OccupyingWorker (현재 점유 중인 Worker, Entity.Null이면 비어있음) |
| CarriedResourceOwner.cs | CarriedResource가 참조하는 Worker 엔티티 |

---

## 컴포넌트 - 스탯 (Shared/Components/Stats/)

| 파일 | 역할 |
| --- | --- |
| GatheringAbility.cs | Worker 채집 능력. MaxCarryAmount (최대 운반량), GatheringSpeed (채집 속도 배수), UnloadDuration (반납 소요 시간) |
| ResourceNodeSetting.cs | 자원 노드 설정. ResourceType (자원 종류), AmountPerGather (1회 채집량), BaseGatherDuration (기본 채집 시간) |

---

## RPC (Shared/RPCs/)

| 파일 | 역할 |
| --- | --- |
| GatherRequestRpc.cs | 채집 요청. WorkerGhostId, ResourceNodeGhostId, ReturnPointGhostId (0이면 자동 찾기) |
| ReturnResourceRequestRpc.cs | 반납 요청. WorkerGhostId, ResourceCenterGhostId |

---

## 태그 (Shared/Components/Tags/)

| 파일 | 역할 |
| --- | --- |
| CarriedResourceTag.cs | CarriedResource 엔티티 식별용 태그 |
| WorkerCarriedResourceLinked (WorkerCarriedResourceSpawnSystem.cs 내 정의) | Worker에 CarriedResource가 이미 생성됨을 표시 (중복 생성 방지) |

---

## GatherPhase 상태 전환

```
None (채집 중 아님)
       ↓ GatherRequestRpc 수신
       ├─ 점유 가능 → MovingToNode
       └─ 점유 중 → WaitingForNode

MovingToNode (노드로 이동)
       ↓ 노드 도착
       ├─ 점유 가능 + 자원=0 → Gathering
       ├─ 점유 불가 → WaitingForNode
       └─ 이미 자원 보유 → MovingToReturn

Gathering (채집 중)
       ↓ Progress >= 1.0
       → CarriedAmount 증가 + 점유 해제 → MovingToReturn

MovingToReturn (반납지로 이동)
       ↓ 반납지 도착
       → Unloading

Unloading (자원 하차)
       ↓ Progress >= 1.0
       → UserCurrency 증가 + CarriedAmount=0
       ├─ AutoReturn=true → MovingToNode (자동 복귀)
       └─ AutoReturn=false → None (대기)

WaitingForNode (점유 대기)
       ↓ 점유 해제 감지 + 거리 내
       → Gathering
```

---

## 점유(Occupancy) 시스템

### 점유 규칙

- 한 ResourceNode에 1개 Worker만 채집 가능
- `ResourceNodeState.OccupyingWorker`로 관리
- `Entity.Null`이면 비어있음
- **재명령 시 자기 자신 점유 허용**: 이미 점유 중인 워커에게 같은 노드로 재명령이 들어오면 `currentOccupier == workerEntity` 체크로 점유를 유지하고 MovingToNode로 전환. 이를 통해 재명령 시 WaitingForNode로 강등되어 발생하는 데드락을 방지

### 점유 해제 시점

| 상황 | 처리 시스템 |
| --- | --- |
| 채집 완료 (Progress >= 1.0) | WorkerGatheringSystem.ProcessGathering |
| 채집 중단 (Intent 변경) | WorkerGatheringSystem.ProcessGatheringCancellation |
| Worker 사망/삭제 | ResourceNodeCleanupSystem |
| Worker HP <= 0 | ResourceNodeCleanupSystem |
| 다른 노드로 타겟 변경 | ResourceNodeCleanupSystem |
| Intent가 Gather가 아닌 경우 | ResourceNodeCleanupSystem |

### ResourceNodeCleanupSystem 상세

1. **점유 유효성 검사** (모든 ResourceNode 순회)
   - OccupyingWorker가 더 이상 존재하지 않음 → 점유 해제
   - Worker가 Dead/Dying 상태 → 점유 해제
   - Worker HP <= 0 → 점유 해제
   - Worker Intent != Gather → 점유 해제
   - Worker GatheringTarget != 이 노드 → 점유 해제

2. **타겟 유효성 검사** (Gather Intent인 Worker 순회)
   - ResourceNode 삭제됨 → Idle로 전환
   - ReturnPoint 삭제됨 → 가장 가까운 ResourceCenter 재탐색, 없으면 Idle

---

## CarriedResource 시각화 패턴

### 생성 (WorkerCarriedResourceSpawnSystem)

```
Worker 생성 감지 (WorkerTag + Without WorkerCarriedResourceLinked)
       ↓
CarriedResource 엔티티 Instantiate
       ↓
CarriedResourceOwner.WorkerEntity = Worker
       ↓
LinkedEntityGroup에 추가 (Worker 삭제 시 함께 삭제)
       ↓
WorkerCarriedResourceLinked 태그 추가
```

### 업데이트 (CarriedResourceFollowSystem)

```
매 프레임:
Position = Worker.Position + (0, 1.2f, 0)  // 머리 위
Scale = CarriedAmount > 0 ? 1f : 0f        // 가시성 토글
```

### 장점

- **Structural Change 없음**: 엔티티 생성/삭제 RPC 불필요
- **네트워크 최적화**: CarriedAmount 동기화만으로 시각 제어
- **자동 정리**: LinkedEntityGroup으로 Worker 삭제 시 함께 삭제

---

## 시스템 실행 순서

```
[GhostInputSystemGroup - Client]
UnitCommandInputSystem → RPC 전송

[SimulationSystemGroup - Server]
HandleGatherRequestSystem → GatheringTarget, Intent, Phase 설정
HandleReturnResourceRequestSystem → Phase.MovingToReturn 설정
WorkerCarriedResourceSpawnSystem → CarriedResource 생성
    ↓ UpdateAfter: HandleBuildRequestSystem
WorkerGatheringSystem → 채집 사이클 5단계 처리 (state.Dependency.Complete() 호출)

[SimulationSystemGroup - Server, OrderLast=true]
ResourceNodeCleanupSystem → 점유/타겟 유효성 검사 (state.Dependency.Complete() 호출)

[TransformSystemGroup - Shared]
CarriedResourceFollowSystem → CarriedResource 위치/스케일 업데이트
```

---

## 상태 머신 조합

채집 시스템은 **3개의 상태 조합**으로 정확한 상태를 추적:

| Intent | Action | Phase | 의미 |
|--------|--------|-------|------|
| Gather | Moving | MovingToNode | 자원 노드로 이동 중 |
| Gather | Working | Gathering | 자원 채집 중 |
| Gather | Moving | MovingToReturn | 반납 지점으로 이동 중 |
| Gather | Working | Unloading | 자원 하차 중 |
| Gather | Moving | WaitingForNode | 노드 점유 대기 중 |

---

## ResourceCenter 소유권 검증

멀티플레이어 환경에서 Worker가 **자신의 유저가 소유한 ResourceCenter**에만 자원을 반납할 수 있도록 서버에서 GhostOwner를 검증한다.

### 검증 위치

| 시스템 | 검증 내용 |
|--------|----------|
| HandleGatherRequestSystem | `FindNearestResourceCenter()`에서 Worker와 같은 GhostOwner를 가진 ResourceCenter만 탐색 |
| HandleReturnResourceRequestSystem | `ProcessRequest()`에서 ResourceCenter의 GhostOwner가 Worker 소유자와 일치하는지 검증 |
| WorkerGatheringSystem | `FindNearestResourceCenter()`에서 소유권 필터링 (채집 완료/대기 상태에서 반납지 재탐색 시) |
| ResourceNodeCleanupSystem | `FindNearestResourceCenter()`에서 소유권 필터링 (ReturnPoint 삭제 시 대체 탐색) |

### 검증 로직

```csharp
// Worker와 ResourceCenter의 GhostOwner.NetworkId 비교
int workerOwnerId = _ghostOwnerLookup[workerEntity].NetworkId;

foreach (var (transform, entity) in SystemAPI.Query<RefRO<LocalTransform>>()
    .WithAll<ResourceCenterTag>()
    .WithEntityAccess())
{
    if (!_ghostOwnerLookup.HasComponent(entity)) continue;
    if (_ghostOwnerLookup[entity].NetworkId != workerOwnerId) continue;

    // 같은 소유자의 ResourceCenter만 선택
}
```

### 동작 결과

- 다른 유저의 ResourceCenter에 자원 반납 시도 → 요청 무시 (RPC 처리 중단)
- 아군 ResourceCenter가 없는 상태에서 채집 요청 → 채집 불가
- 채집 완료 후 반납지 탐색 → 아군 ResourceCenter만 대상

---

## 게임플레이 시나리오 예시

```
Time 0.0s: Worker A/B/C 선택, ResourceNode 우클릭
→ 모두 GatherRequestRpc 전송, Phase.MovingToNode

Time 2.0s: Worker A 도착
→ 점유 설정 (OccupyingWorker = A), Phase.Gathering
→ Worker B/C: 점유 불가, Phase.WaitingForNode

Time 6.0s: Worker A 채집 완료
→ CarriedAmount += 8, 점유 해제
→ Phase.MovingToReturn
→ Worker B: 점유 가능, Phase.Gathering 전환

Time 9.0s: Worker A 반납 완료
→ UserCurrency += 8, CarriedAmount = 0
→ CarriedResourceFollowSystem: Scale = 0 (숨김)
→ AutoReturn=true → Phase.MovingToNode (자동 복귀)
```
