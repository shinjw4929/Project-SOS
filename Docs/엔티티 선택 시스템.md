# 엔티티 선택 시스템

## 전체 흐름

```
[사용자 입력] 마우스 클릭/드래그
    ↓
[GhostInputSystemGroup]
UserSelectionInputUpdateSystem → Phase 상태 머신 업데이트
    ↓ UpdateAfter
EntitySelectionSystem → Selected 컴포넌트 토글
    ↓ UpdateAfter
SelectedEntityInfoUpdateSystem → SelectedEntityInfoState 싱글톤 계산
    ↓ (분기)
    ├─ UnitCommandInputSystem → 유닛 명령 RPC
    └─ StructureCommandInputSystem → 건물 명령 처리

[SimulationSystemGroup]
SelectionRingSpawnSystem → 선택 링 엔티티 생성/삭제

[TransformSystemGroup]
SelectionVisualizationSystem → 선택 링 위치/색상 업데이트
```

## 데이터 구조

### 컴포넌트 (Shared/Components/Flags/)

파일: SelectedTag.cs
```csharp
struct Selected : IComponentData, IEnableableComponent
```
- 선택 상태를 나타내는 태그 컴포넌트
- IEnableableComponent로 빠른 On/Off 토글 가능 (Structural Change 없음)

### 싱글톤 (Client/Component/Singleton/)

파일: UserSelectionInputState.cs
```csharp
struct UserSelectionInputState : IComponentData
{
    SelectionPhase Phase;      // Idle/Pressing/Dragging/PendingClick/PendingBox
    float2 StartScreenPos;     // 드래그 시작 좌표
    float2 CurrentScreenPos;   // 현재 마우스 좌표
}
```

파일: SelectedEntityInfoState.cs
```csharp
struct SelectedEntityInfoState : IComponentData
{
    Entity PrimaryEntity;      // 대표 선택 엔티티 (UI 표시용)
    int SelectedCount;         // 선택된 엔티티 수
    SelectionCategory Category; // None/Units/Structure
    bool IsOwnedSelection;     // 내 소유 엔티티만 선택되었는지
}
```

### 선택 링 컴포넌트 (Shared/Components/Selection/)

| 파일 | 역할 |
| --- | --- |
| SelectionRingTag.cs | 선택 링 엔티티 식별 태그 |
| SelectionRingOwner.cs | 선택 링이 따라갈 대상 엔티티 참조 |
| SelectionRingLinked.cs | 엔티티에 선택 링이 연결되었음을 표시 |

---

## 시스템 실행 흐름

### Phase 1: 입력 감지

파일: UserSelectionInputUpdateSystem.cs
그룹: GhostInputSystemGroup

```
Idle 상태
↓ [마우스 좌클릭]
Pressing 상태
↓ [5px 이상 드래그]        ↓ [짧은 클릭 후 릴리즈]
Dragging 상태              PendingClick 상태
↓ [마우스 릴리즈]
PendingBox 상태
```

주요 로직:
- Idle → Pressing: 마우스 좌클릭 시 StartScreenPos 저장
- Pressing → Dragging: 드래그 거리 5px 초과 시
- Pressing → PendingClick: 짧은 클릭 후 릴리즈
- Dragging → PendingBox: 드래그 중 릴리즈

---

### Phase 2: 선택 처리

파일: EntitySelectionSystem.cs
그룹: GhostInputSystemGroup (UpdateAfter: UserSelectionInputUpdateSystem)

이벤트 기반 처리: PendingClick 또는 PendingBox Phase일 때만 실행

**2-1. 단일 클릭 처리 (HandleSingleClick)**
```
[1] 레이캐스트 수행 (클릭 위치)
    ↓
[2] FindSelectableEntity() - Collider가 자식이면 부모 찾기
    ↓
[3] UnitTag/StructureTag 체크
    ↓
[4] DeselectAll(ecb) - 기존 선택 모두 해제
    ↓
[5] SelectEntity(ecb, hitEntity) - Selected 컴포넌트 Enable
    ↓
Phase → Idle
```

**2-2. 박스 선택 처리 (HandleBoxSelection)**
```
[1] 드래그 박스 min/max 계산
    ↓
[2] DeselectAll(ecb) - 기존 선택 해제
    ↓
[3] Query<LocalTransform, Team>.WithAll<GhostOwnerIsLocal, UnitTag>()
    ↓
[4] 각 유닛의 화면 좌표를 박스 범위와 비교
    ↓
[5] 범위 내 엔티티 → SelectEntity(ecb, entity)
    ↓
Phase → Idle
```

주요 메서드:
- HandleSingleClick(): Physics 레이캐스트 → 단일 선택
- HandleBoxSelection(): 화면 좌표 박스 범위 체크 → 다중 선택
- FindSelectableEntity(): 부모 엔티티 탐색 (Collider가 자식일 경우)
- SelectEntity(): ecb.SetComponentEnabled<Selected>(entity, true)
- DeselectAll(): ecb.SetComponentEnabled<Selected>(entity, false)

---

### Phase 3: 선택 상태 계산

파일: SelectedEntityInfoUpdateSystem.cs
그룹: GhostInputSystemGroup (UpdateAfter: EntitySelectionSystem)

```
[1] SelectedEntityInfoState 초기화
    ↓
[2] Query<Selected>() 순회 (IsComponentEnabled 체크)
    ↓
[3] 첫 번째 엔티티 → PrimaryEntity 저장
    ↓
[4] UnitTag/StructureTag 체크 → Category 결정
    ↓
[5] Team 체크 → IsOwnedSelection 판단
    ↓
SelectedEntityInfoState 업데이트 완료
```

계산되는 값:
- PrimaryEntity: 첫 번째 선택 엔티티 (BuilderTag 체크 등에 사용)
- SelectedCount: UI 표시용
- Category: Units/Structure 구분 (혼합 선택 시 예외 발생)
- IsOwnedSelection: 내 소유만 선택되었는지

---

### Phase 4: 선택 링 생성

파일: SelectionRingSpawnSystem.cs
그룹: SimulationSystemGroup

```
[1] Selected 활성화된 엔티티 중 SelectionRingLinked 없는 것 탐색
    ↓
[2] 팀에 따라 적절한 선택 링 프리팹 선택 (Ally/Enemy/Neutral)
    ↓
[3] SelectionRing 엔티티 Instantiate
    ↓
[4] SelectionRingOwner.TargetEntity = 선택된 엔티티
    ↓
[5] 선택된 엔티티에 SelectionRingLinked 태그 추가

[선택 해제 시]
[1] Selected 비활성화된 엔티티 중 SelectionRingLinked 있는 것 탐색
    ↓
[2] 연결된 SelectionRing 엔티티 삭제
    ↓
[3] SelectionRingLinked 태그 제거
```

---

### Phase 5: 시각화

파일: SelectionVisualizationSystem.cs
그룹: TransformSystemGroup

```
[1] Query<SelectionRingTag, SelectionRingOwner>() 순회
    ↓
[2] Owner 엔티티의 LocalTransform 조회
    ↓
[3] SelectionRing 위치를 Owner 위치로 업데이트
    ↓
[4] 필요시 색상/크기 업데이트
```

---

## 전체 흐름 요약

```
[사용자 입력]
    ↓
UserSelectionInputUpdateSystem (GhostInputSystemGroup)
    → Phase 상태 머신 업데이트 (Idle/Pressing/Dragging/PendingClick/PendingBox)
    ↓ UpdateAfter
EntitySelectionSystem (GhostInputSystemGroup)
    → PendingClick: HandleSingleClick() - 레이캐스트 → SelectEntity()
    → PendingBox: HandleBoxSelection() - 박스 범위 체크 → SelectEntity()
    → ECB로 Selected 컴포넌트 Enable/Disable 기록
    → Phase → Idle
    ↓ UpdateAfter
SelectedEntityInfoUpdateSystem (GhostInputSystemGroup)
    → Selected 활성화 엔티티 순회
    → SelectedEntityInfoState 계산 (PrimaryEntity, Count, Category, IsOwned)
    ↓
SelectionRingSpawnSystem (SimulationSystemGroup)
    → Selected 활성화 시 SelectionRing 엔티티 생성
    → Selected 비활성화 시 SelectionRing 엔티티 삭제
    ↓
SelectionVisualizationSystem (TransformSystemGroup)
    → SelectionRing 위치를 Owner 위치로 업데이트
    ↓
[UI/다른 시스템에서 SelectedEntityInfoState 참조]
    → 건설 메뉴 진입 조건 (BuilderTag 체크)
    → 유닛 명령 (이동/공격)
    → 정보 UI 표시
```

## 핵심 설계 패턴

1. **Phase 기반 상태 머신**: 입력 처리를 명확한 단계로 분리
2. **이벤트 기반 처리**: PendingClick/PendingBox Phase일 때만 선택 로직 실행
3. **ECB 패턴**: 메인 스레드가 아닌 Job에서 안전하게 엔티티 수정
4. **IEnableableComponent**: Selected 태그의 빠른 On/Off (Structural Change 없음)
5. **시스템 의존성**: UpdateAfter 속성으로 실행 순서 보장
6. **선택 링 분리**: 선택 시각화를 별도 엔티티로 관리 (SelectionRing)

## 시스템 의존성 다이어그램

```
[GhostInputSystemGroup]
UserSelectionInputUpdateSystem
    ↓ UpdateAfter
EntitySelectionSystem
    ↓ UpdateAfter
SelectedEntityInfoUpdateSystem
    ↓ UpdateAfter (분기)
    ├─ UnitCommandInputSystem
    │      ↓ UpdateAfter
    │  StructurePlacementInputSystem
    └─ StructureCommandInputSystem (병렬)

[SimulationSystemGroup]
SelectionRingSpawnSystem

[TransformSystemGroup]
SelectionVisualizationSystem
```

## 프리팹 (Assets/Prefabs/UI/)

| 프리팹 | 용도 |
| --- | --- |
| SelectionRingAlly.prefab | 아군 선택 링 (초록색) |
| SelectionRingEnemy.prefab | 적 선택 링 (빨간색) |
| SelectionRingNeutral.prefab | 중립 선택 링 (노란색) |